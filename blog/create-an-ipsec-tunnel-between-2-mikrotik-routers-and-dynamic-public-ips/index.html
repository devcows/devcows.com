<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=robots content="all,follow">
<meta name=googlebot content="index,follow,snippet,archive">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Create an IPsec tunnel between 2 Mikrotik routers and dynamic public IPs</title>
<meta name=author content="Adrian Moreno">
<meta name=keywords content="mikrotik,vpn,ipsec">
<meta name=description content>
<meta name=generator content="Hugo 0.87.0">
<link href="//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800" rel=stylesheet type=text/css>
<link rel=stylesheet href=//use.fontawesome.com/releases/v5.11.2/css/all.css>
<link rel=stylesheet href=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous>
<link href=/css/animate.css rel=stylesheet>
<link href=/css/style.default.css rel=stylesheet id=theme-stylesheet>
<link href=/css/custom.css rel=stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon href=/img/apple-touch-icon.png>
<link href=/css/owl.carousel.css rel=stylesheet>
<link href=/css/owl.theme.css rel=stylesheet>
<link rel=alternate href=http://www.devcows.com/index.xml type=application/rss+xml title=DevCows>
<meta property="og:locale" content="en_us">
<meta property="og:site_name" content="DevCows">
<meta property="og:title" content="Create an IPsec tunnel between 2 Mikrotik routers and dynamic public IPs">
<meta property="og:type" content="article">
<meta property="og:url" content="http://www.devcows.com/blog/create-an-ipsec-tunnel-between-2-mikrotik-routers-and-dynamic-public-ips/">
<meta property="og:description" content>
<meta property="og:image" content="http://www.devcows.com/media/mikrotik_ipsec.png">
<meta property="og:image:type" content="image/png">
<meta property="og:image:width" content="648">
<meta property="og:image:height" content="500">
<meta property="og:updated_time" content="2016-01-26T00:00:00Z">
<meta property="article:tag" content="mikrotik">
<meta property="article:tag" content="vpn">
<meta property="article:tag" content="ipsec">
<meta property="article:published_time" content="2016-01-26T00:00:00Z">
<meta property="article:modified_time" content="2016-01-26T00:00:00Z">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Create an IPsec tunnel between 2 Mikrotik routers and dynamic public …">
<meta name=twitter:image content="http://www.devcows.com/media/mikrotik_ipsec.png">
<meta name=twitter:description content>
</head>
<body>
<div id=all>
<header class=navbar-affixed-top data-spy=affix data-offset-top=62>
<div class="navbar navbar-default yamm" role=navigation id=navbar>
<div class=container>
<div class=navbar-header>
<a class="navbar-brand home" href=/>
<img src=/media/devcows-logo.png alt="Create an IPsec tunnel between 2 Mikrotik routers and dynamic public IPs logo" class="hidden-xs hidden-sm">
<img src=/ alt="Create an IPsec tunnel between 2 Mikrotik routers and dynamic public IPs logo" class="visible-xs visible-sm">
<span class=sr-only>Create an IPsec tunnel between 2 Mikrotik routers and dynamic public IPs - go to homepage</span>
</a>
<div class=navbar-buttons>
<button type=button class="navbar-toggle btn-template-main" data-toggle=collapse data-target=#navigation>
<span class=sr-only>Toggle Navigation</span>
<i class="fas fa-align-justify"></i>
</button>
</div>
</div>
<div class="navbar-collapse collapse" id=navigation>
<ul class="nav navbar-nav navbar-right">
</ul>
</div>
<div class="collapse clearfix" id=search>
<form class=navbar-form role=search>
<div class=input-group>
<input type=text class=form-control placeholder=Search>
<span class=input-group-btn>
<button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button>
</span>
</div>
</form>
</div>
</div>
</div>
</header>
<div id=heading-breadcrumbs>
<div class=container>
<div class=row>
<div class=col-md-12>
<h1>Create an IPsec tunnel between 2 Mikrotik routers and dynamic public IPs</h1>
</div>
</div>
</div>
</div>
<div id=content>
<div class=container>
<div class=row>
<div class=col-md-9 id=blog-post>
<p class="text-muted text-uppercase mb-small text-right">
|
2016-01-26
</p>
<div id=post-content>
<p>In this post we are going to create an IPsec VPN tunnel between two remote sites using Mikrotik routers with dynamic public IPs . By default, Mikrotik does not allow to use FQDN (domain names) to setup an IPsec tunnel, so we are going to create some scripts to update the IPsec configuration whenever the local or remote IPs change.</p>
<p>The network layout is as follows:</p>
<pre><code>    &lt;img src=&quot;http://www.devcows.com/media/mikrotik-ipsec-1.png&quot; alt=&quot;Mikrotik IPsec&quot; /&gt;
</code></pre>
<p>The first thing to take into account is that LAN addresses must be different between Site 1 and Site 2. In our example, Site 1 uses LAN 192.168.1.0/24, whereas Site 2 uses 192.168.2.0/24. You can replace these networks with the ones in your infrastructure.</p>
<p>Another thing to consider is if your routers are behind a NAT. In this case you will have to make sure to forward port 500 (UDP) to the Mikrotik router.</p>
<p>In order to configure the IPsec tunnel, we have to setup the proposal, the peer, and the policy. We are going to provide the commands to configure Site 1, so once you finish with the guide, start over reverting the source and destination LAN addresses to configure Site 2.</p>
<p>First, let’s create an IPsec proposal:</p>
<pre><code>/ip ipsec proposal add name=proposal1 auth-algorithms=md5 enc-algorithms=3des pfs-group=modp1024 disabled=no
</code></pre><p>Now, let’s create the peer. Replace the “test” secret with whatever password you want to use. Leave the address as it is as we will update it later from a script.</p>
<pre><code>/ip ipsec peer add address=10.0.0.2 port=500 auth-method=pre-shared-key secret=test send-initial-contact=yes nat-traversal=no proposal-check=obey hash-algorithm=md5 enc-algorithm=3des dh-group=modp1024 generate-policy=no comment=&quot;myIPsec&quot;
</code></pre><p>And, finally, let’s create a policy that will identify interesting traffic that should go through the IPsec tunnel. Again, let’s leave the “sa-src-address” and “sa-dst-address” as shown.</p>
<pre><code>/ip ipsec policy add action=encrypt disabled=no src-address=192.168.1.0/24 dst-address=192.168.2.0/24 level=require ipsec-protocols=esp protocol=all tunnel=yes sa-src-address=10.0.0.1 sa-dst-address=10.0.0.2 proposal=proposal1 comment=&quot;myIPsec&quot;
</code></pre><p>The IPsec portion is now configured in Site 1. But we need to add a couple of NAT rules to accept the IPsec traffic.</p>
<p>The following NAT rule will allow us to reach IPs on the remote LAN from our local network. It is important that this rule is placed in the first position.</p>
<pre><code>/ip firewall nat add chain=srcnat src-address=192.168.1.0/24 dst-address=192.168.2.0/24 place-before=0 action=accept comment=&quot;IPsec traffic NAT bypass&quot;
</code></pre><p>Add also this rule If we do not already have a NAT rule to masquerade internal traffic.</p>
<pre><code>/ip firewall nat add chain=srcnat src-address=192.168.1.0/24 place-before=1 action=masquerade comment=&quot;Masquerade internal network&quot;
</code></pre><p>Now, we need to create an account in a dynamic DNS service that will allow the remote site to always find out the other site’s public IP. In this guide we are using the No-IP.com service and provide scripts to update the IP of No-IP hosts. You are free to use whatever dynamic DNS service you want.</p>
<p>Once you have created an account and a host for Site 1, go ahead and the following script to update the No-IP host and the IPsec policy in the event of an IP change.</p>
<p>The script source is located here: <a href=https://gist.github.com/adrianmo/e54fbcd2c9d3cce80260>https://gist.github.com/adrianmo/e54fbcd2c9d3cce80260</a></p>
<p>It may be more convenient to create the script from the UI, whether it is the web UI or Winbox. Enable “read”, “write”, and “test” policies, paste the script in the source field and replace the variables within the “Script Settings” section with your information. If you have followed the guide, leave the “IPsecComment” variable as it is. Replace the “WANInter” with the WAN interface that has the public IP of Site 1.</p>
<pre><code>    &lt;img src=&quot;http://www.devcows.com/media/mikrotik-ipsec-2.png&quot; alt=&quot;Mikrotik IPsec&quot; /&gt;
</code></pre>
<p>You can run the script manually and check the logs to verify whether the No-IP host and the IPsec policy are updated successfully.</p>
<pre><code>/log print
</code></pre><p>Now we need to create an scheduler to run the script every time period. We considered that a 10 minute interval is quite balanced, but you can adjust it to your particular needs.</p>
<pre><code>/system scheduler add disabled=no interval=10m name=no-ip_ddns_scheduler on-event=”no-ip_ddns_update” policy=read,write,test start-date=jan/01/1970 start-time=00:00:01
</code></pre><p>At this point Site 1 No-IP host should update automatically whenever its public IP changes and will also update the IPsec policy accordingly. Now we need to update Site 2 public IP in the IPsec peer and policy configuration, so create a No-IP host for Site 2 if you don’t have it already. Do not worry about the IP that this host is resolving to, it will be updated in Site 2 when we repeat the steps on Site 2.</p>
<p>The script to update the IPsec peer and policy when Site 2 public IP changes can be found here: <a href=https://gist.github.com/adrianmo/92e305123b521b7a4400>https://gist.github.com/adrianmo/92e305123b521b7a4400</a></p>
<p>Again, create a script from the UI and replace “RemoteNOIPHost” with the host name of Site 2.</p>
<pre><code>    &lt;img src=&quot;http://www.devcows.com/media/mikrotik-ipsec-3.png&quot; alt=&quot;Mikrotik IPsec&quot; /&gt;
</code></pre>
<p>You can run the script manually and check the logs to verify that the IPsec peer and policy are updated successfully. For testing purposes, you can manually modify the IP from the No-IP control panel and verify that the script updates the IPsec configuration with the new IP.</p>
<pre><code>/log print
</code></pre><p>We are now done with the configuration on Site 1, so it is time to move to Site 2 and go through it again configuring the IPs in the reverse order.</p>
<p>If you feel so inclined, please let us know how it went and leave some feedback if you find it useful.</p>
</div>
<div id=comments>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//devcows.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</div>
<div class=col-md-3>
<div class="panel panel-default sidebar-menu">
<div class=panel-heading>
<h3 class=panel-title>Search</h3>
</div>
<div class=panel-body>
<form action=//google.com/search method=get accept-charset=utf-8 role=search>
<div class=input-group>
<input type=search name=q class=form-control placeholder=Search>
<input type=hidden name=sitesearch value=http://www.devcows.com/>
<span class=input-group-btn>
<button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button>
</span>
</div>
</form>
</div>
</div>
<div class="panel sidebar-menu">
<div class=panel-heading>
<h3 class=panel-title>Tags</h3>
</div>
<div class=panel-body>
<ul class=tag-cloud>
<li>
<a href=/tags/ambilight><i class="fas fa-tags"></i> ambilight</a>
</li>
<li>
<a href=/tags/android><i class="fas fa-tags"></i> android</a>
</li>
<li>
<a href=/tags/arduino><i class="fas fa-tags"></i> arduino</a>
</li>
<li>
<a href=/tags/deluge><i class="fas fa-tags"></i> deluge</a>
</li>
<li>
<a href=/tags/google-maps><i class="fas fa-tags"></i> google-maps</a>
</li>
<li>
<a href=/tags/hdd-usb><i class="fas fa-tags"></i> hdd-usb</a>
</li>
<li>
<a href=/tags/humidity><i class="fas fa-tags"></i> humidity</a>
</li>
<li>
<a href=/tags/ipsec><i class="fas fa-tags"></i> ipsec</a>
</li>
<li>
<a href=/tags/kodi><i class="fas fa-tags"></i> kodi</a>
</li>
<li>
<a href=/tags/meteodino><i class="fas fa-tags"></i> meteodino</a>
</li>
<li>
<a href=/tags/mikrotik><i class="fas fa-tags"></i> mikrotik</a>
</li>
<li>
<a href=/tags/raspberry-pi><i class="fas fa-tags"></i> raspberry-pi</a>
</li>
<li>
<a href=/tags/temperature><i class="fas fa-tags"></i> temperature</a>
</li>
<li>
<a href=/tags/vpn><i class="fas fa-tags"></i> vpn</a>
</li>
<li>
<a href=/tags/xbmc><i class="fas fa-tags"></i> xbmc</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div class="col-md-4 col-sm-6">
<h4>About us</h4>
<p>We are specialized in Ruby on Rails, Django and Android development.</p><p>If you want to obtain more information about the team, please, feel free to <a href=/contact>contact us</a>. We would love to hear from you.</p>
<hr class="hidden-md hidden-lg hidden-sm">
</div>
<div class="col-md-4 col-sm-6">
<h4>Recent posts</h4>
<div class=blog-entries>
<div class="item same-height-row clearfix">
<div class="image same-height-always">
<a href=http://www.devcows.com/blog/create-an-ipsec-tunnel-between-2-mikrotik-routers-and-dynamic-public-ips/>
<img src=/media/mikrotik_ipsec.png class=img-responsive alt="Create an IPsec tunnel between 2 Mikrotik routers and dynamic public IPs">
</a>
</div>
<div class="name same-height-always">
<h5><a href=http://www.devcows.com/blog/create-an-ipsec-tunnel-between-2-mikrotik-routers-and-dynamic-public-ips/>Create an IPsec tunnel between 2 Mikrotik routers and dynamic public IPs</a></h5>
</div>
</div>
<div class="item same-height-row clearfix">
<div class="image same-height-always">
<a href=http://www.devcows.com/blog/arduino-ambilight-xbmc/>
<img src=/media/ambilight.jpg class=img-responsive alt="Homemade ambilight with Arduino and Kodi">
</a>
</div>
<div class="name same-height-always">
<h5><a href=http://www.devcows.com/blog/arduino-ambilight-xbmc/>Homemade ambilight with Arduino and Kodi</a></h5>
</div>
</div>
<div class="item same-height-row clearfix">
<div class="image same-height-always">
<a href=http://www.devcows.com/blog/be-in-sync-with-raspberry/>
<img src=/media/BTSync.png class=img-responsive alt="Be sync with Raspberry Pi">
</a>
</div>
<div class="name same-height-always">
<h5><a href=http://www.devcows.com/blog/be-in-sync-with-raspberry/>Be sync with Raspberry Pi</a></h5>
</div>
</div>
</div>
<hr class="hidden-md hidden-lg">
</div>
<div class="col-md-4 col-sm-6">
<h4>Contact</h4>
<p><strong><u>DevCows</u></strong>
<br>Avda. Països Catalans, 28 B - local B
<br>Sant Pere i Sant Pau
<br>43007
<br>Tarragona
<br>
<strong>Spain</strong>
</p>
<a href=/contact class="btn btn-small btn-template-main">Go to contact page</a>
<hr class="hidden-md hidden-lg hidden-sm">
</div>
</div>
</footer>
<div id=copyright>
<div class=container>
<div class=col-md-12>
<p class=pull-left>Copyright (c) 2015 - 2016, DevCows; all rights reserved.</p>
<p class=pull-right>
Template by <a href=https://bootstrapious.com/p/universal-business-e-commerce-template>Bootstrapious</a>.
Ported to Hugo by <a href=https://github.com/devcows/hugo-universal-theme>DevCows</a>.
</p>
</div>
</div>
</div>
</div>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-57386726-1','auto'),ga('send','pageview'))</script>
<script src=//code.jquery.com/jquery-3.1.1.min.js integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin=anonymous></script>
<script src=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js></script>
<script src=/js/front.js></script>
<script src=/js/owl.carousel.min.js></script>
</body>
</html>